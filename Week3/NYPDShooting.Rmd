---
title: "NYPDShooting"
author: "Chan Chi Shing"
date: "2024-03-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r load library}
```


```{r load library}
library(tidyverse)
library(lubridate)

```

```{r read data from URL}
# Reference https://catalog.data.gov/dataset by following the documentation
# the URL of the CSV is https://data.cityofnewyork.us/resource/833y-fsy8.csv?$limit=30000
# by the time of wirting this code there is 27K+ rows, so $limit is set to 30000

url_nypd_shooting<-"https://data.cityofnewyork.us/resource/833y-fsy8.csv?$limit=30000"

nypd_raw<-read_csv(url_nypd_shooting)      
      

```

```{r renive Geo-Map related column, as no intention to do analysis on that area}
nypd_raw<-nypd_raw %>%
   select(-c(x_coord_cd:geocoded_column))

```



```{r there are duplicated values of incident_key but no rows are exactely the same, why ?}

dup_incident_key<-nypd_raw %>%
  group_by(incident_key) %>%
  filter(n()>1) %>%
  ungroup() %>%
  select(incident_key)

dup_incident_key %>%
  count()

nypd_raw %>%
     filter(duplicated(nypd_raw)==TRUE) %>%
     count()

```

```{r sample example rows of duplicated incident_key, the \'duplicated\' inclidnet_key is related to multiple perp for the same incident}

nypd_raw %>%
  filter(incident_key==nth(dup_incident_key,10)$incident_key)

nypd_raw %>%
  filter(incident_key==nth(dup_incident_key,101)$incident_key)


nypd_raw %>%
  filter(incident_key==nth(dup_incident_key,9356)$incident_key)

```
``` {r find the number of shooting incident per day}
shooting_by_date <- nypd_raw %>% 
     distinct(incident_key,occur_date) %>%
     group_by(occur_date) %>%
     count() %>%
     rename(count=n) %>%
     mutate(wday=wday(occur_date,label = TRUE))
```


## Number of Shooting on Weekend vs Weekdays in NY
Is it true that there is more shooting on weekend than weekday ?
First get a summary of average number of shooting cases by date of week
``` {r find average no of shooting incident by day of week }
shooting_by_wday <-shooting_by_date %>%
	group_by(wday) %>%
	summarize(Mean = mean(count))

```

Visualize the difference of average on Sunday and Saturday (weekends) vs weekdays by bar plot.  The average number of shooting is higher on Weekends.
```{r}
shooting_by_wday %>%
	ggplot(aes(x=wday, y=Mean)) +
	geom_bar(stat="identity",fill="steelblue")+
	labs(title="NYPD average no of shooting incident by day of week")


```

shooting_by_year <-shooting_by_date %>%
        mutate(year=floor_date(occur_date,unit="year")) %>%
	group_by(year) %>%
	summarize(count = sum(count))
```{r}
shooting_by_year <-shooting_by_date %>%
  mutate(year=floor_date(occur_date,unit="year")) %>%
	group_by(year) %>%
  summarize(count = sum(count))
```


```{r}
shooting_by_year  %>%
	ggplot(aes(x=year,y=count)) +
	geom_point(aes(color="count")) +
	geom_line(aes(color="count")) +
	labs(title="test",y=NULL)
```

```{r split into 2 linear model per2019 and post 2019, this model is likely an overfit model for future year not suitable for making future prediction}

shooting_by_year_per2019 <- shooting_by_year %>%
                            filter(year<='2019-01-01')

shooting_by_year_post2019 <- shooting_by_year %>%
                            filter(year>'2019-01-01')

mod_pre2019  <- lm(count ~ year, data=shooting_by_year_per2019)
mod_post2019 <- lm(count ~ year, data=shooting_by_year_post2019) 

shooting_by_year_pred_pre2019 <- shooting_by_year_per2019 %>% mutate(overfit_pred=predict(mod_pre2019))
shooting_by_year_pred_post2019 <- shooting_by_year_post2019 %>% mutate(overfit_pred=predict(mod_post2019))

shooting_by_year_pred <- bind_rows(shooting_by_year_pred_pre2019 ,shooting_by_year_pred_post2019)



```


```{r}
shooting_by_year_pred  %>%
	ggplot(aes(x=year,y=count)) +
        geom_point(aes(color="count")) +
	geom_point(aes(x=year,y=overfit_pred,color="overfit_pred")) +
	geom_line(aes(x=year,y=overfit_pred,color="overfit_pred"))

```

